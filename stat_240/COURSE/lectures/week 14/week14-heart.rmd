---
title: "Cholesterol and Heart Disease"
output: html_document
---

These lectures are based on materials from UC-Berkeley's Data8 course.

### Setup details

* You will need the packages `tidyverse` for these lectures.  

* This assumes you have the R script `viridis.R` and `ggprob.R` two steps back from the working directory (`"../../scripts/viridis.R"`, `"../../scripts/ggprob.R"`).  Be sure to adjust the code if you have these scripts in different locations.

* The following data files will be used and are assumed to be located two steps back from the working directory in a folder called `data/`.  Be sure to adjust the code if you have the data files in a different location.  
`"../../data/causes_of_death.csv"`  
`"../../data/framingham.csv"`   
`"../../data/serum_cholesterol.csv"`  
`"../../data/mortality_summary.csv"`  


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE,message=FALSE,warning=FALSE,cache=TRUE,autodep=TRUE,cache.comments=FALSE)
library(tidyverse)
library(modelr)
library(kableExtra)
source("../../scripts/viridis.R")
source("../../scripts/ggprob.R")
```



# Causes of Death

We are going to be investigating some aspects of cardiovascular disease, which has been the leading cause of death in the world for decades.

We'll begin by exploring a data set that reveals the major causes of death in the world from 1900 to 2015.

```{r}
causes <- read_csv("../../data/causes_of_death.csv") %>%
  rename(age_adj_death_rate = `Age Adjusted Death Rate`)


causes %>%
  count(Year)

causes %>%
  count(Cause)

ggplot(causes, aes(x=Year, y=age_adj_death_rate, color=Cause)) +
  geom_line(size = 2) +
  ylab("Age-adjusted death rate") +
  ggtitle("Major causes of death in the world",
          subtitle = "1900 - 2015") +
  theme_bw() +
  theme(text = element_text(size=20))
```


- The five causes of death considered are Accidents, Cancer, Heart Disease, Influenza and Pneumonia, and Stroke  
- The variable `age_adj_death_rate` is the age-adjusted death rate.   
    - This is the death rate that would have existed if the population studied that year had the same age distribution as a baseline population.  
    - Using these age-adjusted values allows us to compare values across years without concern about changing demographics.
    
- Notice that heart disease has had the highest death rate over the period of study.  
    - There is a spike in 1918 with influenza and pneumonia surpassing heart disease; this was during the 1918 flu pandemic (aka the Spanish flu)  
    - From about 1940 - 1960 heart disease seems to hit its peak, and has been on the decline since around 1960  
    -  Some possible explanations for the decline are related to broader awareness in some regions of the world of lifestyle factors associated with cardiovascular disease (e.g., smoking, poor diet, little or no exercise), or due to improved treatments

    

## The Framingham Heart Study

- The Framingham Heart Study is a long-term observational study of heart disease  
- It began in 1948 studying a group of over 5000 volunteer participants from Framingham, MA  
- The study has continued for decades, where children of previous participants have been studied  
- You can read an overview of the study [here](https://en.wikipedia.org/wiki/Framingham_Heart_Study)

We are going to explore data on 3842 subjects from the first wave of the study, collected in 1956.

```{r}
fram <- read_csv("../../data/framingham.csv")
fram
```


- There is one row for each subject in our data  
- The first seven variables are measurements on a subject at the time of their initial medical exam when the study began  
- `ANYCHD` indicates if the subject developed some form of heart disease at any point after the study began; 1 = yes, 0 = no  
- Our data excludes subjects who already had heart disease as well as subjects with missing data  

- You can read more about the history of the Framingham study [here](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC1449227/)







# Diabetes in the population

Before we begin our investigation into cholesterol and heart disease, we'll first look at some limitations of this data set. In particular, we will investigate a way in which this is or isn't a representative sample of the population by examining the proportion of subjects with diabetes.

- We will eventually be carrying out an investigation about cholesterol using the Framingham data  

- One aspect of the Framingham data we can check is how the prevalence of diabetes in the sample compares with the population  
- The Center for Disease Control (CDC) has [slides](https://www.cdc.gov/diabetes/statistics/slides/long_term_trends.pdf) discussing the prevalence of diagnosed diabetes (i.e., the percentage of the population who have it) in the U.S. around this time (1958);  the stated prevalence was 0.93%.  
    - "The prevalence of diagnosed diabetes increased from 0.93% in 1958 to 7.40% in 2015. In 2015, 23.4 million people had diagnosed diabetes, compared to only 1.6 million in 1958."

This is a great opportunity for us to carry out a hypothesis test!

We are going to conduct a hypothesis test with the following null and alternative hypotheses:

$$H_0: p = 0.0093$$ 

- Where p is the probability that the population of possible participants in the Framingham Study has diabetes.  For the null hypothesis, the probability that a possible participant within the Framingham Study has diabetes is equivalent to the prevalence of diagnosed diabetes within the population. (i.e., any difference is due to chance).

$$H_a:  p \neq 0.0093$$  

- The probability that a possible participant in the Framingham Study has diabetes is different than the prevalence of diagnosed diabetes within the population.


If it is reasonable to consider that the number of participants diagnosed with diabetes follows a Binomial distribution, then *under the null* $X \sim \text{Binomial}(3842,0.0093)$, we can consider a hypothesis test using $X$ as the test statistic.

If the null hypothesis is true, then we expect that an observed value of $X$ will be *close* to the mean, $np = 3842 \times 0.0093 = 35.7306$.  

```{r}
p_pop <- 0.0093
diabetes <- fram$DIABETES
n <- length(diabetes)
p_fram <- mean(diabetes)
p_fram

```
 
The standard deviation is $\sqrt{np(1-p)} = \sqrt{3842(0.0093)(1-0.0093)} = 5.95$ so values from about 30 to 42 (within one standard deviation of the mean) would be typical.

Let's plot the Binomial distribution under the null along with the observed test statistic:

```{r}
x_fram <- sum(diabetes)  ## observed count
x_fram

n*p_pop #Mean assuming H0 is true

gbinom(n, p_pop, a = qbinom(.001,n,p_pop),b = qbinom(.999,n,p_pop)) +
  geom_vline(aes(xintercept=x_fram), color="red", linetype="dashed") +
  theme_bw() +
  theme(text=element_text(size=20))
```

$x=105$ would be a very unusual value of our null distribution - it would be far into the upper tail (see on the previous plot)

This is suggesting there will be a small p-value, which we compute next.

```{r}
p_105 = dbinom(x_fram, n, p_pop) #P(X = 105)
p_105 #Very small!

## Because p_105 is so small, there are only contributions to the p-value in the upper tail
temp = tibble(
  x = 0:n,
  prob = dbinom(x, n, p_pop)) %>% 
  filter(prob < p_105 | near(prob, p_105, tol=10^(-22))) #adjust tolerance

pvalue = temp %>% 
  summarize(pvalue = sum(prob)) %>% 
  pull(pvalue)

pvalue

##Another option:
sum(dbinom(x_fram:n, n, p_pop), na.rm=TRUE)

x_fram/n #phat
p_pop #US population prevalence
```

The p-value is very small suggesting that we can reject the null hypothesis.  In context, the proportion of participants in the Framingham study who have diabetes is greater than the U.S. population (p-value <0.0001, Binomial test), and implies that the Framingham participants may not be a representative sample of the population (at least in terms of diabetes prevalence).


- Why isn't the Framingham sample more representative of the population?  There could be different reasons for this.  
- The participants volunteered for the study rather than being selected randomly.  Perhaps more people with known conditions such as diabetes wanted to volunteer.  Also, the study is based in Framingham, MA so it possible that town is not representative of the broader US population.  
- In real-world studies it is very challenging to get a sample of participants that is truly representative of the population.  Geographical, socioeconomic, community, and class factors (among others) would likely need to be accounted for in obtaining such a sample.  
- To get a more representative sample, it would also be necessary to ensure that the medical exams were standardized across different participants.  
- Hence, obtaining such a representative sample would likely have a higher cost of collecting the data.  
-  Despite these concerns, the Framingham study collected high-quality medical data from its subjects, even if the subjects may not be a perfect representation of the population of all Americans.  
- We are going to keep using these data, but will need to keep their limitations in mind.




# Cholesterol and Heart Disease

One of the main discoveries of the Framingham study was an association between serum cholesterol, which is the amount of cholesterol in the blood, and whether or not a person develops heart disease.

We can frame this as a hypothesis test described as follows:
$$
H_0: \mu_0 = \mu_1
$$
where $\mu_0$ is the mean serum cholesterol level for those who did not develop heart disease during the study, and $\mu_1$ is the mean level for those who did develop heart disease during the study.


$$
H_a: \mu_0 < \mu_1
$$
Notice for we are considering a one-sided alternative, where the cholesterol levels of people in the population who get heart disease are higher, on average, than the cholesterol level of people who do not.

To carry out this test, we will consider a two-sample test with the following test statistic:
$$
T = \frac{(\bar{x}_0-\bar{x}_1) - (\mu_0-\mu_1)}{\sqrt{\frac{s_0^2}{n_0} + \frac{s_1^2}{n_1}}}
$$

where under the null $\mu_0 - \mu_1 = 0$, $n_i$ is the sample size for group $i=0,1$, and $s_i$ is the standard deviation of group $i$.

Since we are estimating the standard error, we will be using a t-distribution rather than a normal distribution.

```{r}
## Subjects who did not develop HD
chol0 <- fram %>%
  filter(ANYCHD == 0) %>%
  pull(TOTCHOL)

## Subjects who did develop HD
chol1 <- fram %>%
  filter(ANYCHD == 1) %>%
  pull(TOTCHOL)

mean0 <- mean(chol0)
sd0 <- sd(chol0)
n0 <- length(chol0)
c(mean0,sd0, n0)

mean1 <- mean(chol1)
sd1 <- sd(chol1)
n1 <- length(chol1)
c(mean1,sd1, n1)


## Assuming the null is true
se <- sqrt(sd0^2/n0+sd1^2/n1)
test_stat_chol <- (mean0-mean1)/se
test_stat_chol

## Get degrees of freedom of t-distribution from t.test()
out = t.test(chol0, chol1, alternative ="less")
out 

dof <- out$parameter
dof

pt(test_stat_chol, dof) # p-value = P(T_dof <= -9.76586)
```

Using a t-distribution with 1545.8 degrees of freedom, we calculate a p-value on the order of $10^{-22}$ suggesting that we can reject the null hypothesis.  This rejections means we have concluded that the mean serum cholesterol level for those who develop heart disease is greater than for those who do not develop heart disease (pvalue <0.0001, one-sided two-sample t test).

Let's visualize the p-value on a plot:
```{r}
gt(df=dof) +
  geom_vline(aes(xintercept = test_stat_chol), color="red", linetype="dashed") +
  geom_t_fill(dof, b = test_stat_chol)+
  theme_bw() +
  theme(text = element_text(size=20))
```

The vertical red dashed line is the observed test statistic, and the p-value is the probability less than or equal to this value.  It is far in the left tail of our null distribution, which is what we'd expect since our calculated p-value is so small.

Even though there is strong evidence that there is an association between high cholesterol and heart disease, this study does not allow us to conclude that high cholesterol *causes* heart disease.

Establishing causality often requires a well-designed and randomized experiment.  In the Framingham study, the participants were volunteers (i.e., not randomly selected) and the study itself was *observational*.  This means the researchers were not controlling how the participants behaved, but only observing the participants.





# The Minnesota Coronary Experiment

To establish a causal link between saturated fat intake, serum cholesterol, and heart disease, a group of doctors in the US established the National Heart-Diet Study.  There were 6 centers involved in this study:  Baltimore, Boston, Chicago, Minneapolis-St. Paul, Oakland, and Faribault, MN.

All but the Faribault location used volunteers from the local population, and the participants were asked to modify their diets to include more or less saturated fat.

- The results from these five centers may not have been able to establish causality.  
- Since they asked the volunteers to each more or less saturated fat, this also could have resulted in the volunteers assigned to eat less saturated fat to also consume fewer calories since the diets were not standardized.  
- Difference in the groups could have been due to health improvements related to consuming fewer calories.


Faribault was a bit different, and this center led to what is now referred to as the Minnesota Coronary Experiment.

- The study was led by Dr. Ivan Frantz and ran from 1968 to 1973
- It was carried out at the Faribault State Hospital; the patients at this hospital were there due to disabilities or mental illness  
- The records suggest there were 9,423 study participants with ages 20 - 97  
-  The records include data from a longitudinal study on serum cholesterol for 2355 participants who maintained the diets for a year or more  
-  The subjects were randomly divided into a control group on a standard diet (including animal fats and margarine) and a diet group (where vegetable oil and corn oil margarine were used in place of half of the saturated fats)  
- There were ethical issues with experimenting on the patients, however, prior to the diet phase patients were able to decline participation.  There are questions about the patients' abilities to provide consent.  For those interested, you can read about recent apologies for the way institutionalized patients were treated in Minnesota in [this article](https://www.tcdailyplanet.net/minnesota-saying-sorry-treatment-persons-disabilities/)
- For more background on the Minnesota Coronary Experiment, check out [this article](https://www.scientificamerican.com/article/records-found-in-dusty-basement-undermine-decades-of-dietary-advice/) from Scientific American from 2017



We will first investigate the data on changes in cholesterol and then we will look into mortality rates for the diets. The data for each individual in the 1968 study is not available; only summary statistics are available. Therefore, we will use artificial synthetic data, based on those summary statistics created by the Data8 instructors at UC-Berkeley.

```{r}
serum_cholesterol <- read_csv("../../data/serum_cholesterol.csv") %>%
  rename(chol_change = `Change in Serum Cholesterol`)
serum_cholesterol

serum_cholesterol %>%
  count(Condition)
```

At the start of the study, the patients' serum cholesterol levels were measured.  This was repeated at the end of the study so that the percentage change in serum cholesterol could be measured.

```{r}
ggplot(serum_cholesterol, aes(x=chol_change/100, fill=Condition)) +
  geom_histogram(alpha=0.4, position="identity", color="black")+
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  ylab("Count") +
  xlab("% Change in Serum Cholesterol") +
  theme_bw() +
  theme(text = element_text(size=20)) +
  geom_vline(xintercept=0, color="red", linetype="dashed")
```


These data can be used to address the question, "Does changing saturated fats to polyunsaturated fats in a person's diet decrease their serum cholesterol levels?"

Since we want to test difference between two samples, we can consider the following hypotheses:

$$
H_0: \mu_0 = \mu_1
$$
where $\mu_0$ represents the unknown population mean percentage cholesterol change for those on the standard diet (control group), and $\mu_1$ represents the unknown population mean percentage cholesterol change for those on the modified diet (treatment group).
 
If the null hypothesis is true, it implies unsaturated fat diet does not change average serum cholesterol levels differently from the control.

$$
H_a: \mu_0 > \mu_1
$$
Notice for we are again considering a one-sided alternative because we want to test if those on the diet had significantly greater *decreases* in cholesterol levels.  That is, if unsaturated fat diet decreases average serum cholesterol levels.  

Since the study has features of a randomized controlled experiment, it may be considered appropriate to use causal language if the null hypothesis is rejected. Though one could also argue that the reproducibility of the results may be needed to better establish causality.



To carry out this test, we will consider a two-sample test with the following test statistic:
$$
T = \frac{(\bar{x}_0-\bar{x}_1) - (\mu_0-\mu_1)}{\sqrt{\frac{s_0^2}{n_0} + \frac{s_1^2}{n_1}}}
$$

where under the null $\mu_0 - \mu_1 = 0$, $n_i$ is the sample size for group $i=0,1$, and $s_i$ is the standard deviation of group $i$.

```{r}
chol0 <- serum_cholesterol %>%
  filter(Condition == "Control") %>%
  pull(chol_change)

chol1 <- serum_cholesterol %>%
  filter(Condition == "Diet") %>%
  pull(chol_change)

mean0 <- mean(chol0)
sd0 <- sd(chol0)
n0 <- length(chol0)
c(mean0,sd0, n0)

mean1 <- mean(chol1)
sd1 <- sd(chol1)
n1 <- length(chol1)
c(mean1,sd1, n1)


## Assuming the null is true
se <- sqrt(sd0^2/n0+sd1^2/n1)
test_stat_chol <- (mean0-mean1)/se
test_stat_chol

## Get degrees of freedom of t-distribution from t.test()
t.test(chol0, chol1, alternative ="greater")

dof <- 2316.5

pt(test_stat_chol, dof, lower.tail = FALSE) # P(T_dof >= 22.96714)
1 - pt(test_stat_chol, dof)
```

The p-value is very small suggesting we can reject the null hypothesis.  In context, there is strong evidence that diets lower in saturated fat reduce cholesterol levels more than the standard diet (p-value<0.0001, one-sided t-test).


Let's visualize the p-value on a plot:
```{r}
gt(df=dof) +
  geom_vline(aes(xintercept = test_stat_chol), color="red", linetype="dashed") +
  xlab("Test Statistic") +
  ylab("Density") +
  geom_t_fill(dof, a = test_stat_chol) +
  theme_bw() +
  theme(text = element_text(size=20))
```


This study suggests that diets lower in saturated fat reduce cholesterol levels.  Next, we will investigate more data from the Minnesota Coronary Experiment to see if changing saturated fats to polyunsaturated fats in a person's diet affects their risk of death.  (Notice the causal language since this was a controlled, randomized experiement.)




# Risk of Death

Continuing with the Minnesota Coronary Experiment, we are going to consider the question, "Does changing saturated fats to polyunsaturated fats in a person's diet affect their risk of death?"

The data set below provides information about the patients, including the number who died.

```{r}
mortality <- read_csv("../../data/mortality_summary.csv") 
mortality

mortality_summary <- mortality %>%
  group_by(Condition) %>%
  summarize(n = sum(Total),  
            deaths = sum(Deaths),   
            chd_deaths = sum(`CHD Deaths`))
mortality_summary

### Compare the age distributions
mortality %>%
  group_by(Condition) %>%
  mutate(group_total = sum(Total)) %>%
  ungroup() %>%
  group_by(Condition, Age) %>%
  summarize(percent = 100*Total/group_total) %>%
  pivot_wider(id_cols=Age, names_from=Condition, values_from=percent)
```


Rather than considering the Coronary Heart Disease (CHD) deaths, we are going to investigate the risk of death (for any cause).

We can write out hypothesis tests as 
$$
H_0: p_0 = p_1
$$
where $p_0$ is the unknown population death rate for those on the standard diet (control group) and $p_1$ is the unknown population death rate for those on the modified diet (treatment group).

$$
H_a: p_0 \neq p_1
$$
suggesting the lower saturated fat diet does cause a different rate of death.  In this case we are using a two-sided alternative, but we could consider a one-sided test instead.

Next we calculate the sample proportions for the two groups:
```{r}
## Estimate phat_0
n0 <- mortality_summary %>%
  filter(Condition == "Control") %>%
  pull(n)
x0 <- mortality_summary %>%
  filter(Condition == "Control") %>%
  pull(deaths)
p0 <- x0/n0
p0
```

```{r}
## Estimate phat_1
n1 <- mortality_summary %>%
  filter(Condition == "Diet") %>%
  pull(n)
x1 <- mortality_summary %>%
  filter(Condition == "Diet") %>%
  pull(deaths)
p1 <- x1/n1
p1

p1 - p0 # observed difference
```

Since we are estimating a difference in proportions for this question, the test statistic will be different from the cases where we were consider means.  

#### Normal approximation

The normal approximation to $\hat{p}_1 - \hat{p}_0$ can be used.  The standard error for $\hat{p}_1 - \hat{p}_0$ is
$$
SE(\hat{p}_1 - \hat{p}_0) = \sqrt{\frac{p_1(1-p_1)}{n_1}+\frac{p_0(1-p_0)}{n_0}}
$$

Under the null hypothesis, $p_1=p_0$ so the standard error can take the form 
$$
SE(\hat{p}_1 - \hat{p}_0) = \sqrt{\bar{p}(1-\bar{p})(\frac{1}{n_1}+\frac{1}{n_0})}
$$

where $\bar{p}$ is estimated by pooling the data as $\bar{p} = \frac{x_1+x_0}{n_1+n_0}$.


This leads to the following test statistic assuming the null is true:
$$
z_p = \frac{\hat{p}_1 - \hat{p}_0 }{\sqrt{\bar{p}(1-\bar{p})(\frac{1}{n_1}+\frac{1}{n_0})}}
$$

We compute the components of our test statistic next:
```{r}
## Estimate phat (pooled)
x <- x0+x1
n <- n0+n1
phat <- x/n
phat

## Estimate SE
se <- sqrt(phat*(1-phat)*(1/n1+1/n0))
se


## Test statistic
z_p <- (p1-p0)/se
z_p

## p-value
pnorm(z_p, lower.tail=FALSE)*2
```

This p-value is larger than standard cutoffs of 0.01 or 0.05 suggesting there is not sufficient evidence to reject our null hypothesis. That is, we do not have reason to believe that the death rates are different between the control diet and the diet with reduced saturated fat.

Let's visualize the p-value on a plot:
```{r}
gnorm() +
  geom_vline(aes(xintercept = z_p), color="red", linetype="dashed") +
  geom_norm_fill(a = z_p)+
  geom_norm_fill(b = -z_p)+
  xlab("Z") +
  ylab("Density") +
  theme_bw() +
  theme(text = element_text(size=20))
```

##### Minnesota Coronary Experiment Results Summary
Overall, it appears that there is not evidence to suggest that the different diets changes the death rate.  

In other words, the Minnesota Coronary Experiment found that the diet with lower saturated fat than the control diet did appear to lower the serum cholesterol levels for the participants.  However, there was not evidence to suggest that the lower cholesterol levels reduced the rates of death (any cause) between the two groups in study.   

If you'd like to learn more about the study, see [this paper](https://www.bmj.com/content/353/bmj.i1246) from 2016



















